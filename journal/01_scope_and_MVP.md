# 01. Scope and MVP Specification  
## Scope: Telegram + Discord (v1.1)

## Основные принципы разработки
- **MVP-first**: Убираем за скобки всё, что не является критически важным.
- **Agentic Development**: Разработка опирается на работу с AI-агентами.
- **Spec-driven**: 
  - Основные источники истины — файлы `journal/XX_spec_name.md`. 
  - В них описываются архитектурные и продуктовые решения.
  - На эти спецификации опирается агент при написании кода.
  - Они служат основой для будущей документации.
- **Итерационный процесс**:
  1. Написание спецификации (specs).
  2. Запуск агента и ревью его плана.
  3. Ревью кода и результатов.
  4. Обновление specs.
  5. Запись в `journal/PROGRESS.md` после каждого значимого изменения.
- **Документация**: `README.md` и другие пользовательские документы создаются ближе к готовности MVP.

## Мы строим MVP

### Objective (Цель)
Создание устойчивого Telegram / Discord бота, который:
1. Работает в групповых Telegram чатах и Discord каналах.
2. Запоминает часовые пояса пользователей.
3. Отвечает расширенным сообщением на упоминание времени, конвертируя его для всех участников.

### Architecture Overview

```
┌─────────────┐     ┌─────────────┐
│  Telegram   │     │  Discord    │
│   Group     │     │   Server    │
└──────┬──────┘     └──────┬──────┘
       │                   │
       ▼                   ▼
┌─────────────┐     ┌─────────────┐
│ src/commands│     │ src/discord │
│ (Telegram)  │     │ (Discord)   │
└──────┬──────┘     └──────┬──────┘
       │                   │
       └─────────┬─────────┘
                 ▼
┌───────────────────────────────────────────────────┐
│                  SHARED CORE                       │
│  ┌─────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │ Capture │─▶│  Transform  │─▶│   Formatter   │  │
│  │ (Regex) │  │ (UTC-Pivot) │  │  (Response)   │  │
│  └─────────┘  └─────────────┘  └───────────────┘  │
│                      │                             │
│       ┌──────────────┼──────────────┐              │
│       ▼              ▼              ▼              │
│  ┌─────────┐  ┌──────────────┐  ┌─────────┐       │
│  │   Geo   │  │   Storage    │  │  Config │       │
│  │(Geocode)│  │   (SQLite)   │  │  (YAML) │       │
│  └─────────┘  └──────────────┘  └─────────┘       │
└───────────────────────────────────────────────────┘
```

### Qualities (Качества)
- **Простота**: Не требует сложных действий от пользователя.
- **Детекция**: Распознавание времени основано на Regex.
- **Точность времени**: Трансформация устойчива к сезонным сдвигам (IANA database).
- **Легкое администрирование**: Конфигурация через `.yaml` и `.env`.

---

## Technology Stack

### Core (Shared)

| Component | Library | Purpose |
|-----------|---------|---------|
| Runtime | `python` 3.12+ | Includes `sqlite3` |
| Storage | `aiosqlite` | Async SQLite wrapper |
| Timezone | `zoneinfo`, `tzdata` | IANA timezone database |
| Geocoding | `geopy`, `timezonefinder` | City → Coords → Timezone |
| Config | `PyYAML`, `python-dotenv` | Configuration management |
| Package | `uv` | Dependency & env management |
| Linter | `ruff` | Fast Python linter & formatter |

### Telegram

| Component | Library | Purpose |
|-----------|---------|---------|
| Bot API | `aiogram` | Async Telegram Bot wrapper |

### Discord

| Component | Library | Purpose |
|-----------|---------|---------|
| Bot API | `discord.py` 2.x | Async Discord Bot wrapper |

---

## High-level Configuration

### Структура ответа
- Четко определенная схема сообщения.
- Единый формат времени.
- **Обработка дат**: Пометка если время переходит на следующий день.
- **Группировка**: Совпадающие часовые пояса — время один раз, города через запятую.

### Алгоритм
1. Regex детекция времени.
2. Любая конвертация идёт через UTC (прямые Local→Local запрещены).

---

## Out of Scope (За рамками текущего MVP)
- Активное подтверждение действий (переспрашивание геолокации)
- LLM fallbacks для распознавания
- Поддержка WhatsApp
- Fuzzy matching для детекции времени (e.g. `rapidfuzz`)
- Объединение нескольких времён в одно сообщение

---

## Constraints (Чего делать не надо)
- **No Hardcode**: Никакого хардкода городов и часовых поясов.
- **No LLM Fallbacks**: Не используем LLM в рантайме (дорого).
- **No Private Chats**: Бот работает только в групповых чатах/серверах.
